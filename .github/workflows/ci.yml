name: CI

on:
  push:
  pull_request:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux x86_64
            libtorch-url: https://download.pytorch.org/libtorch/cpu/libtorch-cxx11-abi-shared-with-deps-2.7.1%2Bcpu.zip
            libtorch-archive: libtorch.zip
          - os: ubuntu-24.04-arm
            name: Linux ARM64
            libtorch-url: https://github.com/second-state/libtorch-releases/releases/download/v2.7.1/libtorch-cxx11-abi-aarch64-2.7.1.tar.gz
            libtorch-archive: libtorch.tar.gz
          - os: macos-latest
            name: macOS ARM64
            libtorch-url: https://download.pytorch.org/libtorch/cpu/libtorch-macos-arm64-2.7.1.zip
            libtorch-archive: libtorch.zip

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.name }})

    steps:
      - uses: actions/checkout@v4

      - name: Install FFmpeg dev libraries (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libavcodec-dev libavformat-dev libavutil-dev libswresample-dev pkg-config

      - name: Install FFmpeg (macOS)
        if: runner.os == 'macOS'
        run: brew install ffmpeg

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ runner.arch }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-cargo-

      - name: Download libtorch
        run: curl -Lo ${{ matrix.libtorch-archive }} "${{ matrix.libtorch-url }}"

      - name: Extract libtorch
        run: |
          if [[ "${{ matrix.libtorch-archive }}" == *.zip ]]; then
            unzip -q ${{ matrix.libtorch-archive }}
          else
            tar xzf ${{ matrix.libtorch-archive }}
          fi

      - name: Set linker rpath-link (Linux only)
        if: runner.os == 'Linux'
        run: echo "RUSTFLAGS=-C link-arg=-Wl,-rpath-link,${{ github.workspace }}/libtorch/lib" >> "$GITHUB_ENV"

      - name: Build
        env:
          LIBTORCH: ${{ github.workspace }}/libtorch
          LIBTORCH_BYPASS_VERSION_CHECK: "1"
        run: cargo build --release

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install HuggingFace tools
        run: pip install huggingface_hub transformers

      - name: Set library path (Linux)
        if: runner.os == 'Linux'
        run: echo "LD_LIBRARY_PATH=${{ github.workspace }}/libtorch/lib:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"

      - name: Set library path (macOS)
        if: runner.os == 'macOS'
        run: echo "DYLD_LIBRARY_PATH=${{ github.workspace }}/libtorch/lib:$DYLD_LIBRARY_PATH" >> "$GITHUB_ENV"

      - name: Cache model weights
        uses: actions/cache@v4
        with:
          path: Qwen3-ASR-0.6B
          key: qwen3-asr-0.6b-v1

      - name: Download model
        run: python3 -c "from huggingface_hub import snapshot_download; snapshot_download('Qwen/Qwen3-ASR-0.6B', local_dir='Qwen3-ASR-0.6B')"

      - name: Generate tokenizer.json
        run: |
          python3 -c "
          from transformers import AutoTokenizer
          tok = AutoTokenizer.from_pretrained('Qwen3-ASR-0.6B', trust_remote_code=True)
          tok.backend_tokenizer.save('Qwen3-ASR-0.6B/tokenizer.json')
          print('Saved tokenizer.json')
          "

      - name: Transcribe sample1 (English)
        run: |
          echo "=== Sample 1 (English) ==="
          ./target/release/asr Qwen3-ASR-0.6B test_audio/sample1.wav

      - name: Transcribe sample2 (English)
        run: |
          echo "=== Sample 2 (English) ==="
          ./target/release/asr Qwen3-ASR-0.6B test_audio/sample2.wav

      - name: Transcribe sample3 (Chinese)
        run: |
          echo "=== Sample 3 (Chinese) ==="
          ./target/release/asr Qwen3-ASR-0.6B test_audio/sample3.wav

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: qwen3-asr-${{ matrix.os }}-${{ runner.arch }}.zip
          path: target/release/asr
